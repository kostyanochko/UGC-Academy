<<<<<<< Updated upstream
document.addEventListener("DOMContentLoaded",(function(){const form=document.getElementById("applicationForm"),phoneInput=form.querySelector('input[name="phone"]'),nameInput=form.querySelector('input[name="name"]'),reasonInput=form.querySelector('textarea[name="reason"]'),submitBtn=form.querySelector('button[type="submit"]'),loader=submitBtn.querySelector(".ui-loader");form.setAttribute("novalidate",!0);const maskTemplate="+52 ___ ___ ____",editablePartStart=4;let isPhoneActive=!1;function initPhoneMask(){phoneInput.addEventListener("focus",onPhoneFocus),phoneInput.addEventListener("blur",onPhoneBlur),phoneInput.addEventListener("input",onPhoneInput),phoneInput.addEventListener("keydown",onPhoneKeyDown),phoneInput.addEventListener("click",onPhoneClick)}function initLabelAnimations(){form.querySelectorAll(".ui-field__label").forEach(label=>{const input=label.querySelector("input, textarea");input.addEventListener("focus",(function(){label.classList.add("ui-field--active"),input!==phoneInput||isPhoneActive||activatePhoneField()})),input.addEventListener("blur",(function(){""!==this.value&&(this!==phoneInput||this.value!==maskTemplate&&isPhoneActive)||label.classList.remove("ui-field--active")})),input.value&&input.value!==maskTemplate&&label.classList.add("ui-field--active")})}function showError(field,message){const fieldContainer=field.closest(".ui-field"),errorSpan=fieldContainer.querySelector(".ui-field__desc");fieldContainer.classList.add("ui-field--error"),errorSpan.textContent=message,errorSpan.classList.add("ui-field__desc--error")}function clearError(field){const fieldContainer=field.closest(".ui-field"),errorSpan=fieldContainer.querySelector(".ui-field__desc");fieldContainer.classList.remove("ui-field--error"),errorSpan.textContent="",errorSpan.classList.remove("ui-field__desc--error")}function activatePhoneField(){isPhoneActive||(phoneInput.value=maskTemplate,isPhoneActive=!0),setTimeout(()=>{phoneInput.setSelectionRange(4,4)},0),clearError(phoneInput)}function onPhoneClick(){if(isPhoneActive){const pos=Math.max(phoneInput.selectionStart,4);phoneInput.setSelectionRange(pos,pos)}else activatePhoneField()}function onPhoneFocus(){if(isPhoneActive){const pos=Math.max(phoneInput.selectionStart,4);phoneInput.setSelectionRange(pos,pos)}else activatePhoneField()}function onPhoneBlur(){const digits=getDigitsFromInput();(digits.length<10||phoneInput.value.includes("_"))&&(phoneInput.value="",isPhoneActive=!1,clearError(phoneInput))}function onPhoneInput(){if(!isPhoneActive)return;const digits=getDigitsFromInput(),selectionStart=phoneInput.selectionStart;if(!digits.length)return phoneInput.value=maskTemplate,void phoneInput.setSelectionRange(4,4);phoneInput.value=formatPhoneNumber(digits);let newCursorPos=getNextCursorPosition(selectionStart,digits.length);newCursorPos=Math.max(newCursorPos,4),setTimeout(()=>{phoneInput.setSelectionRange(newCursorPos,newCursorPos)},0),clearError(phoneInput)}function onPhoneKeyDown(e){if(!isPhoneActive)return e.preventDefault(),void activatePhoneField();[8,9,27,13,35,36,37,38,39,40].includes(e.keyCode)||((e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault(),phoneInput.selectionStart<4&&(e.preventDefault(),phoneInput.setSelectionRange(4,4)))}function getDigitsFromInput(){const value=phoneInput.value;let digits="";for(let i=4;i<value.length;i++)/\d/.test(value[i])&&(digits+=value[i]);return digits}function formatPhoneNumber(digits){let result=maskTemplate.split(""),digitIndex=0;for(let i=4;i<result.length&&digitIndex<digits.length;i++)"_"===result[i]&&(result[i]=digits[digitIndex++]);return result.join("")}function getNextCursorPosition(currentPos,digitsLength){const value=phoneInput.value;for(let i=Math.max(currentPos,4);i<value.length;i++)if("_"===value[i])return i;return value.length}function validateForm(){let isValid=!0;nameInput.value.trim()||(showError(nameInput,"Por favor ingrese su nombre"),isValid=!1);const phoneDigits=getDigitsFromInput();return phoneDigits.length<10&&(showError(phoneInput,"Ingrese un número de 10 dígitos"),isValid=!1),reasonInput.value.trim()||(showError(reasonInput,"Por favor indique la razón de su solicitud"),isValid=!1),isValid}async function sendToCRM(formData){try{console.log("Sending to CRM:",formData);const response=await fetch("https://api.crm.com/leads",{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json",Authorization:"Bearer YOUR_API_KEY"},body:JSON.stringify(formData)});return console.log("CRM response status:",response.status),!0}catch(error){return console.error("Error sending to CRM:",error),!1}}function backupToGoogleSheets(formData){return new Promise((resolve,reject)=>{const callbackName="jsonp_callback_"+Math.random().toString(36).substr(2,9),scriptId="jsonp_script_"+callbackName;window[callbackName]&&delete window[callbackName];const oldScript=document.getElementById(scriptId);oldScript&&document.body.removeChild(oldScript);const url=new URL("https://script.google.com/macros/s/AKfycbxnZgRu1dm7duyVRvt6j39KX9ztlZZqV21suCipSzIOtqTwnz6SWF6sOA4Ozwy2AvBINg/exec");url.searchParams.append("callback",callbackName);for(const key in formData)formData.hasOwnProperty(key)&&url.searchParams.append(key,formData[key]);window[callbackName]=response=>{delete window[callbackName];const script=document.getElementById(scriptId);script&&document.body.removeChild(script),response&&response.success?resolve(response):reject(new Error(response.error||"Unknown server error"))};const script=document.createElement("script");script.id=scriptId,script.src=url.toString(),script.onerror=()=>{delete window[callbackName],reject(new Error("Failed to load the script"))},document.body.appendChild(script),setTimeout(()=>{if(window[callbackName]){delete window[callbackName];const script=document.getElementById(scriptId);script&&document.body.removeChild(script),reject(new Error("Request timeout"))}},1e4)})}form.addEventListener("submit",(async function(e){if(e.preventDefault(),form.querySelectorAll(".ui-field").forEach(field=>{field.classList.remove("ui-field--error");const desc=field.querySelector(".ui-field__desc");desc.textContent="",desc.classList.remove("ui-field__desc--error")}),validateForm())try{submitBtn.disabled=!0,loader.style.display="flex",submitBtn.querySelector(".ui-button__text").style.visibility="hidden";const formData={name:nameInput.value.trim().replace(/[&<>"'`=\/]/g,""),phone:"+52"+getDigitsFromInput(),instagram:form.querySelector('input[name="instagram"]').value.trim()||"Not specified",reason:reasonInput.value.trim(),date:(new Date).toISOString().slice(0,19).replace("T"," ")},crmSuccess=await sendToCRM(formData);await backupToGoogleSheets(formData).catch(e=>{console.error("Backup also failed:",e)});const successMessage=document.querySelector(".message__success");successMessage.style.display="flex",form.reset(),phoneInput.value="",isPhoneActive=!1,document.querySelector(".message__close-btn").addEventListener("click",(function(){successMessage.style.display="none"})),form.querySelectorAll(".ui-field__label").forEach(label=>{label.classList.remove("ui-field--active")})}catch(error){console.error("Error:",error),showError(reasonInput,"Error al enviar. Intente nuevamente.")}finally{submitBtn.disabled=!1,loader.style.display="none",submitBtn.querySelector(".ui-button__text").style.visibility="visible"}})),form.querySelectorAll("input, textarea").forEach(input=>{input.addEventListener("input",(function(){const field=this.closest(".ui-field");field.classList.remove("ui-field--error");const desc=field.querySelector(".ui-field__desc");desc.textContent="",desc.classList.remove("ui-field__desc--error")}))}),initPhoneMask(),initLabelAnimations()}));
=======
document.addEventListener("DOMContentLoaded",(function(){const form=document.getElementById("applicationForm"),phoneInput=form.querySelector('input[name="phone"]'),nameInput=form.querySelector('input[name="name"]'),reasonInput=form.querySelector('textarea[name="reason"]'),submitBtn=form.querySelector('button[type="submit"]'),loader=submitBtn.querySelector(".ui-loader");form.setAttribute("novalidate",!0);const maskTemplate="+52 (___) ___-____",editablePartStart=5;let isPhoneActive=!1;function initPhoneMask(){phoneInput.addEventListener("focus",onPhoneFocus),phoneInput.addEventListener("blur",onPhoneBlur),phoneInput.addEventListener("input",onPhoneInput),phoneInput.addEventListener("keydown",onPhoneKeyDown),phoneInput.addEventListener("click",onPhoneClick)}function initLabelAnimations(){form.querySelectorAll(".ui-field__label").forEach(label=>{const input=label.querySelector("input, textarea");input.addEventListener("focus",(function(){label.classList.add("ui-field--active"),input!==phoneInput||isPhoneActive||activatePhoneField()})),input.addEventListener("blur",(function(){""!==this.value&&(this!==phoneInput||this.value!==maskTemplate&&isPhoneActive)||label.classList.remove("ui-field--active")})),input.value&&input.value!==maskTemplate&&label.classList.add("ui-field--active")})}function showError(field,message){const fieldContainer=field.closest(".ui-field"),errorSpan=fieldContainer.querySelector(".ui-field__desc");fieldContainer.classList.add("ui-field--error"),errorSpan.textContent=message,errorSpan.classList.add("ui-field__desc--error")}function clearError(field){const fieldContainer=field.closest(".ui-field"),errorSpan=fieldContainer.querySelector(".ui-field__desc");fieldContainer.classList.remove("ui-field--error"),errorSpan.textContent="",errorSpan.classList.remove("ui-field__desc--error")}function activatePhoneField(){phoneInput.value=maskTemplate,phoneInput.setSelectionRange(5,5),isPhoneActive=!0,clearError(phoneInput)}function onPhoneClick(){isPhoneActive||activatePhoneField()}function onPhoneFocus(){isPhoneActive||activatePhoneField()}function onPhoneBlur(){const digits=getDigitsFromInput();(digits.length<10||phoneInput.value.includes("_"))&&(phoneInput.value="",isPhoneActive=!1,clearError(phoneInput))}function onPhoneInput(){if(!isPhoneActive)return;const digits=getDigitsFromInput(),selectionStart=phoneInput.selectionStart;if(!digits.length)return phoneInput.value=maskTemplate,void phoneInput.setSelectionRange(5,5);phoneInput.value=formatPhoneNumber(digits),phoneInput.setSelectionRange(getNextCursorPosition(selectionStart,digits.length),getNextCursorPosition(selectionStart,digits.length)),clearError(phoneInput)}function onPhoneKeyDown(e){if(!isPhoneActive)return e.preventDefault(),void activatePhoneField();[8,9,27,13,35,36,37,38,39,40].includes(e.keyCode)||((e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault(),phoneInput.selectionStart<5&&(e.preventDefault(),phoneInput.setSelectionRange(5,5)))}function getDigitsFromInput(){const value=phoneInput.value;let digits="";for(let i=5;i<value.length;i++)/\d/.test(value[i])&&(digits+=value[i]);return digits}function formatPhoneNumber(digits){let result=maskTemplate.split(""),digitIndex=0;for(let i=5;i<result.length&&digitIndex<digits.length;i++)"_"===result[i]&&(result[i]=digits[digitIndex++]);return result.join("")}function getNextCursorPosition(currentPos,digitsLength){const value=phoneInput.value;for(let i=Math.max(currentPos,5);i<value.length;i++)if("_"===value[i])return i;return value.length}function validateForm(){let isValid=!0;nameInput.value.trim()||(showError(nameInput,"Por favor ingrese su nombre"),isValid=!1);const phoneDigits=getDigitsFromInput();return phoneDigits.length<10&&(showError(phoneInput,"Ingrese un número de 10 dígitos"),isValid=!1),reasonInput.value.trim()||(showError(reasonInput,"Por favor indique la razón de su solicitud"),isValid=!1),isValid}async function sendToCRM(formData){try{console.log("Sending to CRM:",formData);const response=await fetch("https://api.crm.com/leads",{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json",Authorization:"Bearer YOUR_API_KEY"},body:JSON.stringify(formData)});return console.log("CRM response status:",response.status),!0}catch(error){return console.error("Error sending to CRM:",error),!1}}function backupToGoogleSheets(formData){return new Promise((resolve,reject)=>{const callbackName="jsonp_callback_"+Math.random().toString(36).substr(2,9),scriptId="jsonp_script_"+callbackName;window[callbackName]&&delete window[callbackName];const oldScript=document.getElementById(scriptId);oldScript&&document.body.removeChild(oldScript);const url=new URL("https://script.google.com/macros/s/AKfycbxnZgRu1dm7duyVRvt6j39KX9ztlZZqV21suCipSzIOtqTwnz6SWF6sOA4Ozwy2AvBINg/exec");url.searchParams.append("callback",callbackName);for(const key in formData)formData.hasOwnProperty(key)&&url.searchParams.append(key,formData[key]);window[callbackName]=response=>{delete window[callbackName];const script=document.getElementById(scriptId);script&&document.body.removeChild(script),response&&response.success?resolve(response):reject(new Error(response.error||"Unknown server error"))};const script=document.createElement("script");script.id=scriptId,script.src=url.toString(),script.onerror=()=>{delete window[callbackName],reject(new Error("Failed to load the script"))},document.body.appendChild(script),setTimeout(()=>{if(window[callbackName]){delete window[callbackName];const script=document.getElementById(scriptId);script&&document.body.removeChild(script),reject(new Error("Request timeout"))}},1e4)})}form.addEventListener("submit",(async function(e){if(e.preventDefault(),form.querySelectorAll(".ui-field").forEach(field=>{field.classList.remove("ui-field--error");const desc=field.querySelector(".ui-field__desc");desc.textContent="",desc.classList.remove("ui-field__desc--error")}),validateForm())try{submitBtn.disabled=!0,loader.style.display="flex",submitBtn.querySelector(".ui-button__text").style.visibility="hidden";const formData={name:nameInput.value.trim().replace(/[&<>"'`=\/]/g,""),phone:"+52"+getDigitsFromInput(),instagram:form.querySelector('input[name="instagram"]').value.trim()||"Not specified",reason:reasonInput.value.trim(),date:(new Date).toISOString().slice(0,19).replace("T"," ")},crmSuccess=await sendToCRM(formData);await backupToGoogleSheets(formData).catch(e=>{console.error("Backup also failed:",e)});const successMessage=document.querySelector(".message__success");successMessage.style.display="flex",form.reset(),phoneInput.value="",isPhoneActive=!1,document.querySelector(".message__close-btn").addEventListener("click",(function(){successMessage.style.display="none"})),form.querySelectorAll(".ui-field__label").forEach(label=>{label.classList.remove("ui-field--active")})}catch(error){console.error("Error:",error),showError(reasonInput,"Error al enviar. Intente nuevamente.")}finally{submitBtn.disabled=!1,loader.style.display="none",submitBtn.querySelector(".ui-button__text").style.visibility="visible"}})),form.querySelectorAll("input, textarea").forEach(input=>{input.addEventListener("input",(function(){const field=this.closest(".ui-field");field.classList.remove("ui-field--error");const desc=field.querySelector(".ui-field__desc");desc.textContent="",desc.classList.remove("ui-field__desc--error")}))}),initPhoneMask(),initLabelAnimations()}));
>>>>>>> Stashed changes
